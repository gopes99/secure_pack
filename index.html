<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SecurePack - Generate QR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>Generate Encrypted QR</h2>
  <div id="form" style="display:none;">
    <textarea id="data" placeholder="Enter container contents" rows="5" cols="40"></textarea><br>
    <button onclick="generate()">Generate QR</button><br><br>
    <div id="qrcode"></div>
  </div>
  <pre id="out"></pre>

  <script>
    const allowedCredentialIds = [
      "i4lWVV6ph2bsAe7OWhoPuNIPujY=",
      "0ROJC+nos+nvygnz9y6YTHEeyQw="
    ];

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    async function authenticate() {
      const allowCredentials = allowedCredentialIds.map(id => ({
        type: "public-key",
        id: base64ToArrayBuffer(id),
        transports: ["internal"]
      }));

      const publicKey = {
        challenge: new Uint8Array(32),
        allowCredentials,
        userVerification: "required",
        timeout: 60000
      };

      try {
        const cred = await navigator.credentials.get({ publicKey });
        const usedId = arrayBufferToBase64(cred.rawId).trim();
        const matched = allowedCredentialIds.includes(usedId);

        if (matched) {
          document.getElementById("form").style.display = "block";
        } else {
          document.getElementById("out").innerText = "❌ Access Denied";
        }
      } catch (err) {
        document.getElementById("out").innerText = "❌ Auth failed: " + err;
      }
    }

    async function encryptData(data, key) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(key), "PBKDF2", false, ["deriveKey"]
      );
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const derivedKey = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt"]
      );
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        derivedKey,
        enc.encode(data)
      );
      return arrayBufferToBase64(salt) + "." + arrayBufferToBase64(iv) + "." + arrayBufferToBase64(ciphertext);
    }

    async function generate() {
      const data = document.getElementById("data").value;
      const key = allowedCredentialIds[0]; // Use credential ID as symmetric key
      const encrypted = await encryptData(data, key);
      const url = "https://gopes99.github.io/secure_pack/view.html?data=" + encodeURIComponent(encrypted);
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), { text: url, width: 256, height: 256 });
    }

    authenticate(); // auto-trigger
  </script>
</body>
</html>
