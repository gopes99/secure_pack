<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SecurePack - Create QR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>Secure QR Generator (Face ID)</h2>

  <textarea id="data" placeholder="Enter container content here" rows="6" cols="40"></textarea><br><br>
  <button onclick="encryptAndGenerateLink()">Generate QR (Face ID)</button>

  <div id="qrcode" style="margin-top:20px;"></div>
  <pre id="output"></pre>

  <script>
    const allowedCredentialIds = [
      // Optional: can be empty here, since we're just encrypting
    ];

    async function encryptAndGenerateLink() {
      const plaintext = document.getElementById("data").value;
      if (!plaintext) return alert("Enter some data first.");

      let credential;
      try {
        credential = await navigator.credentials.get({
          publicKey: {
            challenge: new Uint8Array(32),
            allowCredentials: [], // allow any
            userVerification: "required",
          }
        });
      } catch (err) {
        return alert("Authentication failed: " + err.message);
      }

      const rawId = credential.rawId;
      const key = await deriveKey(rawId);
      const encrypted = await encryptAES(plaintext, key);

      const baseUrl = "https://gopes99.github.io/secure_pack/view.html";
      const url = `${baseUrl}?data=${encodeURIComponent(encrypted)}`;

      new QRCode(document.getElementById("qrcode"), {
        text: url, width: 256, height: 256
      });

      document.getElementById("output").textContent = "QR Code generated.\n\n" + url;
    }

    async function deriveKey(rawId) {
      const keyMaterial = await window.crypto.subtle.importKey(
        "raw", rawId, "HKDF", false, ["deriveKey"]
      );
      return await window.crypto.subtle.deriveKey({
        name: "HKDF",
        hash: "SHA-256",
        salt: new Uint8Array(16), // static salt, optional change
        info: new TextEncoder().encode("SecurePack AES Key")
      }, keyMaterial, {
        name: "AES-GCM",
        length: 256
      }, false, ["encrypt", "decrypt"]);
    }

    async function encryptAES(plaintext, key) {
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const encoded = new TextEncoder().encode(plaintext);
      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv }, key, encoded
      );
      const fullData = new Uint8Array([...iv, ...new Uint8Array(ciphertext)]);
      return btoa(String.fromCharCode(...fullData));
    }
  </script>
</body>
</html>
