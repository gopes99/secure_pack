<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SecurePack - View Container</title>
</head>
<body>
  <h2>Secure QR Viewer (Face ID)</h2>
  <div id="output">Authenticating...</div>

  <script>
    // Base64-encoded credential IDs allowed to access content
    const allowedCredentialIds = [
      "7DBAU7Q95Tx7GT3TLcrfAJxXEIA",
      "0ROJC+nos+nvygnz9y6YTHEeyQw="
    ];

    (async function authenticateAndDecrypt() {
      const encryptedData = new URLSearchParams(window.location.search).get("data");
      if (!encryptedData) {
        document.getElementById("output").textContent = "No data found in URL.";
        return;
      }

      try {
        const credential = await navigator.credentials.get({
          publicKey: {
            challenge: new Uint8Array(32),
            allowCredentials: allowedCredentialIds.map(id => ({
              type: "public-key",
              id: base64ToBuffer(id)
            })),
            userVerification: "required"
          }
        });

        const rawId = credential.rawId;
        const credIdBase64 = arrayBufferToBase64(rawId);

        if (!allowedCredentialIds.includes(credIdBase64)) {
          document.getElementById("output").textContent = "Access denied: unrecognized credential.";
          return;
        }

        const key = await deriveKey(rawId);
        const decrypted = await decryptAES(encryptedData, key);
        document.getElementById("output").textContent = "Container Contents:\n\n" + decrypted;

      } catch (err) {
        document.getElementById("output").textContent = "Authentication failed: " + err.message;
      }
    })();

    function base64ToBuffer(base64) {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    async function deriveKey(rawId) {
      const keyMaterial = await window.crypto.subtle.importKey(
        "raw", rawId, "HKDF", false, ["deriveKey"]
      );
      return await window.crypto.subtle.deriveKey({
        name: "HKDF",
        hash: "SHA-256",
        salt: new Uint8Array(16), // Same static salt as index.html
        info: new TextEncoder().encode("SecurePack AES Key")
      }, keyMaterial, {
        name: "AES-GCM",
        length: 256
      }, false, ["encrypt", "decrypt"]);
    }

    async function decryptAES(encoded, key) {
      const raw = Uint8Array.from(atob(encoded), c => c.charCodeAt(0));
      const iv = raw.slice(0, 12);
      const data = raw.slice(12);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
      return new TextDecoder().decode(decrypted);
    }
  </script>
</body>
</html>
