<!DOCTYPE html>
<html>
<head>
  <title>Face ID Auth Test</title>
</head>
<body>
  <h2>Face ID Auth Test</h2>
  <button onclick="auth()">Authenticate</button>
  <pre id="out"></pre>

  <script>
    const allowedCredentialIds = [
      // ✅ Replace this with your real credential ID from register.html
      "PasteYourCredentialIDHere"
    ];

    function base64ToArrayBuffer(b64) {
      const binary = atob(b64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer; // <-- Important: return the buffer, not the view
    }

    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    async function auth() {
      const allowCredentials = allowedCredentialIds.map(id => ({
        type: "public-key",
        id: base64ToArrayBuffer(id), // ✅ Properly parsed
        transports: ["internal"]
      }));

      const publicKey = {
        challenge: new Uint8Array(32),
        allowCredentials,
        userVerification: "required",
        timeout: 60000
      };

      try {
        const cred = await navigator.credentials.get({ publicKey });
        const usedId = arrayBufferToBase64(cred.rawId).trim();

        const matchFound = allowedCredentialIds.some(id => id.trim() === usedId);
        if (matchFound) {
          document.getElementById("out").innerText =
            "✅ Access Granted\n\nUsed Credential:\n" + usedId;
        } else {
          document.getElementById("out").innerText =
            "❌ Access Denied\n\nUsed Credential:\n" + usedId +
            "\n\nAllowed Credentials:\n" + allowedCredentialIds.join("\n");
        }
      } catch (err) {
        document.getElementById("out").innerText = "❌ Authentication failed:\n" + err;
      }
    }
  </script>
</body>
</html>
